services:

  recitsperdus-db:
    image: postgres:16.2
    container_name: recitsperdus-db
    #build:
    #  context: .
    #  dockerfile: ./postgres/Dockerfile
    restart: unless-stopped
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_backup:/backups
    ports:
      - $DATABASE_LOCAL_PORT:$DATABASE_DOCKER_PORT
    env_file: ./.env
    environment:
      - POSTGRES_USER=$DATABASE_USER
      - POSTGRES_DB=$DATABASE_DATABASE
      - POSTGRES_PASSWORD=$DATABASE_ROOT_PASSWORD

  recitsperdus-holocron:
    build:
      context: ./holocron
      dockerfile: ./Dockerfile
      target: prod
    container_name: recitsperdus-holocron
    ports:
      - $HOLOCRON_LOCAL_PORT:$HOLOCRON_DOCKER_PORT
    restart: unless-stopped
    depends_on:
      recitsperdus-db:
        condition: service_started
        restart: false

  recitsperdus-gizka:
    build:
      context: ./gizka
      dockerfile: ./Dockerfile
    container_name: recitsperdus-gizka
    ports:
      - $GIZKA_LOCAL_PORT:$GIZKA_DOCKER_PORT
    env_file: ./.env
    environment:
      - DB_HOST=recitsperdus-db
      - DB_USER=$DATABASE_USER
      - DB_PASSWORD=$DATABASE_ROOT_PASSWORD
      - DB_NAME=$DATABASE_DATABASE
      - DB_PORT=$DATABASE_DOCKER_PORT
    restart: unless-stopped
    depends_on:
      recitsperdus-db:
        condition: service_started
        restart: true
      recitsperdus-holocron:
        condition: service_started
        restart: false

volumes:
  postgres_data:
  postgres_backup: